#!/bin/bash
[ -n "$H_GUARD_GITTER" ] && return
readonly H_GUARD_GITTER=1

LYSITHEA_HISTORY=.lysithea.log
GIT_FORMAT="[lysithea] (auto-generated)"

function init_git() {
  GIT_TARGETS=( "$EXPLOIT.c"  "$LYSITHEA_HISTORY" ".gitignore" )

  if [ -z "$(which git)" ]; then
    _error_exit "$FILE_NOT_FOUND" "git is not installed"
  fi

  if [ -d .git ] ; then
    echo "[-] git is already inited. skipping"
    return
  fi

  git init
  printf "# [Auto generated by lysithea]\n*\n!%s\n!%s\n!%s\n" "$EXPLOIT.c" "$LYSITHEA_HISTORY" ".gitignore" > .gitignore
  git add .
  git commit -m "[lysithea] initial commit"
  echo "[+] initiated git environment"
}

function hook_exploit() {
  trap exploit_callback INT
}

function exploit_callback() {
  echo "[+] saving exploit log..."

  if ! [ -d .git ] ; then
    _error_exit "$FILE_NOT_FOUND" "git is not inited. Run 'lysithea init' first."
  fi

  git add .
  git commit -m "$(printf $GIT_FORMAT)"
}
